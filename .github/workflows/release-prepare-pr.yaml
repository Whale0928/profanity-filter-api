name: Release Prepare PR

on:
  release:
    types: [created, published]

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "branch=release/${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.version.outputs.branch }}
          git push origin ${{ steps.version.outputs.branch }}

      - name: Create PR body file
        run: |
          cat > pr-body.md << EOF
          ## Release ${{ steps.version.outputs.tag }}

          main 브랜치의 변경사항을 릴리즈 브랜치로 배포합니다.

          ### 체크리스트
          - [ ] 버전 정보 확인
          - [ ] 빌드 테스트 완료
          - [ ] 배포 준비 완료

          ### 릴리즈 노트
          ${{ github.event.release.body }}

          ---
          **릴리즈 태그**: [${{ steps.version.outputs.tag }}](${{ github.event.release.html_url }})
          EOF

      - name: Create Pull Request (main → release)
        run: |
          gh pr create \
            --base ${{ steps.version.outputs.branch }} \
            --head main \
            --title "Release ${{ steps.version.outputs.tag }}" \
            --body-file pr-body.md \
            --label release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
