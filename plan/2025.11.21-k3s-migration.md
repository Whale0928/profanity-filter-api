# k3s 마이그레이션 계획

## 개요

기존 VM 기반 Blue-Green 배포를 k3s 클러스터 환경으로 마이그레이션합니다.
경량화된 구조로 GitOps 기반 자동화 배포 환경을 구축하는 것입니다.
공통 인프라(ingress, cert-manager, monitoring)를 활용하여 운영 오버헤드를 최소화합니다.

## 핵심 결정사항

### 1. 레포지토리

- 모노레포: 애플리케이션 코드 + K8s 매니페스트
  - 이유: 코드와 배포 설정의 버전을 함께 관리하여 일관성 유지
- 위치: `deploy/overlays/production/`
- 플랫폼: `module.platform` 서브모듈 (https://github.com/Whale0928/k8s-platform.git)
  - 이유: 공통 인프라를 서브모듈로 참조하여 bottlenote와 일관성 유지

### 2. 컨테이너 레지스트리

- ghcr.io 사용 (ECR 불필요)
  - 이유: 무료, GitHub Actions 통합 용이, 토큰 갱신 불필요 (bottlenote의 ECR CronJob 제거)
- 이미지: `ghcr.io/whale0928/profanity-api:main-SHA`

### 3. 비밀 관리

- External Secrets Operator + 1Password Connect
  - 이유: bottlenote의 AWS Secrets Manager 대신 1Password 사용, 플랫폼 공통 컴포넌트로 관리
- 1Password Connect는 platform에 배포 (`platform/external-secrets/onepassword-connect/`)
- 주의: credentials, token은 절대 Git 커밋 금지 (공개 레포)

### 4. 배포

- ArgoCD GitOps + Webhook
  - 이유: Image Updater 대신 webhook 사용으로 즉각 반응, 경량화
- GitHub Actions에서 이미지 태그 업데이트 후 ArgoCD webhook 호출
- 네임스페이스: `profanity-production`
- 리소스: 512Mi/250m, 레플리카 2
  - 이유: bottlenote(768Mi/500m)보다 경량화
- 도메인: `api-profanity.kr-filter.com`
  - 테스트 완료 후 기존 도메인으로 변경

## 디렉토리 구조

```
profanity-filter-api/
└── deploy/overlays/production/
    ├── namespace.yaml
    ├── deployment.yaml
    ├── service.yaml
    ├── ingress.yaml (cert-manager TLS)
    ├── secret-store.yaml (1Password Connect 참조)
    └── external-secret.yaml (1Password vault 참조)

module.platform/ (서브모듈 - 추가할 항목)
├── argocd/
│   └── webhook-config.yaml (ArgoCD webhook 설정)
└── platform/
    └── external-secrets/
        └── onepassword-connect/
            ├── namespace.yaml (external-secrets-system)
            ├── deployment.yaml
            ├── service.yaml
            └── kustomization.yaml
```

## 배포 흐름

1. 개발자 커밋 (main 브랜치)
2. GitHub Actions 자동 실행:
   - 빌드 및 테스트
   - ghcr.io에 이미지 푸시 (태그: main-SHA)
   - deployment.yaml 이미지 태그 업데이트 (sed)
   - Git commit & push (매니페스트 변경)
   - ArgoCD webhook 호출 (즉시 배포 트리거)
3. ArgoCD: Git 변경 감지 후 즉시 sync 및 배포 (Rolling Update)

## 환경변수

모든 환경변수는 1Password vault에 저장하고 ESO를 통해 K8s Secret으로 동기화합니다.
공개 레포이므로 환경변수 키 목록은 문서에서 제외합니다.

## 보안 체크

### Git 커밋 금지

- credentials.json
- 1password-credentials.json
- Connect token
- 모든 패스워드, API 키

### 수동 생성 (kubectl)

```bash
# 1Password Connect credentials
kubectl create secret generic onepassword-credentials \
  --from-file=credentials.json \
  -n external-secrets-system

# Connect token
kubectl create secret generic op-token \
  --from-literal=token=TOKEN \
  -n profanity-production
```

## GitHub Actions

### 필요한 Secrets

- GHCR_TOKEN: ghcr.io 푸시 권한
- ARGOCD_TOKEN: ArgoCD API 토큰 (webhook 호출용)
- ARGOCD_SERVER: ArgoCD 서버 주소

### 워크플로우

- 트리거: push to main
- 빌드 및 테스트
- 이미지 빌드 및 ghcr.io 푸시
- deployment.yaml 이미지 태그 업데이트 (sed)
- Git commit & push
- ArgoCD webhook 호출 (curl)

## Platform 인프라

### 기존 활용

k8s-platform의 공통 인프라를 활용하여 별도 설치 불필요:
- ingress-nginx: 트래픽 라우팅 및 로드밸런싱
- cert-manager: Let's Encrypt SSL 자동 발급 및 갱신
- monitoring: Prometheus metrics 자동 수집
- ArgoCD: GitOps 기반 배포 관리

### 추가 필요 (platform 레포에 등록)

profanity 프로젝트를 위해 platform에 추가할 컴포넌트:

1. 1Password Connect (`platform/external-secrets/onepassword-connect/`)
   - 1Password vault와 K8s 연동을 위한 Connect 서버
   - Deployment, Service 매니페스트
   - credentials Secret은 수동 생성 (Git 제외)

2. ArgoCD Webhook 설정 (`argocd/webhook-config.yaml`)
   - GitHub Actions에서 배포 트리거용
   - API Token 생성 및 webhook endpoint 구성
